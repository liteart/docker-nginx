upstream intranet-cluster {
    ip_hash;
    server dueis001.bertschi.domain;
}

upstream intranet-cluster-nginx {
    ip_hash;
    server dueis001.bertschi.domain:8080;
}


geo $http_x_forwarded_for $upstream {
    default		intranet-cluster;
    172.20.100.0/24	intranet-cluster-nginx; #Due Neubau ICT-Open
    #172.20.32.0/19	intranet-cluster-nginx;  #Servers
    #172.20.64.0/23	intranet-cluster-nginx;  #Due Altbau Clients
    172.20.80.0/24	intranet-cluster-nginx;  #Due Altbau ICT
    172.20.81.0/24	intranet-cluster-nginx;  #Due Altbau ICT-Open
    #172.20.96.0/24	intranet-cluster-nginx;  #Due Neubau
    #172.21.0.0/24	intranet-cluster-nginx;  #Birrfeld
}

server {
    server_name  intralocal;
    listen       80;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    auth_gss    on;
    auth_gss_keytab /etc/nginx/conf.d/shu.keytab;
    proxy_set_header Authorization "";

    server_tokens off;
    add_header X-Content-Type-Options nosniff;    

    client_max_body_size 100M;
    fastcgi_read_timeout	3600;
    proxy_connect_timeout       3600;
    proxy_send_timeout          3600;
    proxy_read_timeout          3600;
    send_timeout                3600;

    # details see http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffers
    #	          https://www.nginx.com/resources/admin-guide/reverse-proxy/
    #
    proxy_buffer_size   128k;
    proxy_buffers   4 256k;
    proxy_busy_buffers_size   256k;

    # Do not forward Kemp server alive check requests
    if ( $http_user_agent = "KEMP 1.0" ){
        return 200; 
    }


    error_page 502 /502.html;
    location = /502.html {
	root  /etc/nginx/conf.d/errorpages;
    }

    location / {
        proxy_pass http://$upstream;
    }

    location /nginx_status {
      stub_status on;
      access_log   off;
      allow 172.31.0.0/16;  # fix your ip range ie: 172.31.0.0/16 or 192.168.1.0/24
      deny all;
    }

    
    # this file was used to ensure 11 compatibility with legacy pages
    # for more information see https://technet.microsoft.com/library/mt269903.aspx
    # has been set up with florian ruf. Does not work since jun16 (intranet legacy refactoring)
    # added by shu, 2017-10-19
    #
    location /application/Dokumente/EnterpriseCompatibilityList/ecl.xml {
        return 200 '<rules version="60"><emie></emie></rules>';
        add_header Content-Type application/xml;
    }
} 

server {
    server_name  intranet.bertschi.domain intranet;
    listen       85;

    location / {
        proxy_pass http://intranet-cluster;
    }
} 

server {

    server_name  intranet.bertschi.domain intranet;
    listen 443 ssl;

    #for hints @see https://gist.github.com/plentz/6737338
    server_tokens off; #@see http://serverfault.com/questions/214242/can-i-hide-all-server-os-info
    add_header X-Content-Type-Options nosniff;    
    add_header X-Frame-Options "DENY";
    add_header X-XSS-Protection "1; mode=block";

    ssl_certificate /etc/nginx/conf.d/intranet.crt;
    ssl_certificate_key /etc/nginx/conf.d/intranet.key;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    client_max_body_size 100M;
    fastcgi_read_timeout	3600;
    proxy_connect_timeout       3600;
    proxy_send_timeout          3600;
    proxy_read_timeout          3600;
    send_timeout                3600;

    # details see http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffers
    #	          https://www.nginx.com/resources/admin-guide/reverse-proxy/
    #
    proxy_buffer_size   128k;
    proxy_buffers   4 256k;
    proxy_busy_buffers_size   256k;

    location / {
        proxy_pass http://intranet-cluster;
    }

    # this file was used to ensure 11 compatibility with legacy pages
    # for more information see https://technet.microsoft.com/library/mt269903.aspx
    # has been set up with florian ruf. Does not work since jun16 (intranet legacy refactoring)
    # added by shu, 2017-10-19
    #
    location /application/Dokumente/EnterpriseCompatibilityList/ecl.xml {
        return 200 '<rules version="60"><emie></emie></rules>';
        add_header Content-Type application/xml;
    }
}



